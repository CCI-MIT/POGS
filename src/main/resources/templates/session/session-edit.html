<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout.html}">
<!--/*@thymesVar id="_csrf" type="org.springframework.security.web.csrf.CsrfToken"*/-->
 
<head>
    <meta charset="UTF-8">
    <title>POGS - Sessions</title>
</head>
<body>
<div layout:fragment="content" class="container">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin">Home</a></li>
        <li class="breadcrumb-item "><a href="/admin/studies">Studies</a></li>
        <li class="breadcrumb-item " th:if="${study.id != null}">
            <a th:href="${'/admin/studies/' + study.id}" th:text="${study.studyName}"></a>
        </li>
        <li class="breadcrumb-item active" th:if="${sessionBean.id != null}">
            <a th:href="${'/admin/studies/' + study.id+ '/sessions/' + sessionBean.id}" th:text="${sessionBean.sessionSuffix}"></a>
        </li>
    </ol>
    <h2>Edit session</h2>
    <form action="#" id="saveSession" th:action="@{/admin/sessions}" th:object="${sessionBean}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" th:field="*{id}"/>
        <input type="hidden" th:field="*{studyId}"/>
        <input type="hidden" th:field="*{roundsEnabled}" th:value="true"/>
        <input type="hidden" th:field="*{numberOfRounds}" th:value="1"/>

        <input type="hidden" th:field="*{status}" th:value="P" />

        <input type="hidden" th:field="*{teamCreationType}" />

        <fieldset class="form-group row">
            <legend class="col-form-legend col-sm-2">Basic</legend>
            <div class="container">
                <fieldset class="form-group row">
                    <legend class="col-form-legend col-sm-2">Session config</legend>
                    <div class="container">
                        <div class="row">
                            <div class="col">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="sessionStartDate">Session Start Date:</label>

                                    <div class="col-sm-9">
                                        <div class="form-group">
                                            <div class="input-group date" id="x" data-target-input="nearest">
                                                <input type="text" autocomplete="off" class="form-control" data-target="#sessionStartDate1" id="sessionStartDate" th:field="*{sessionStartDate}"/>
                                                <div class="input-group-append" data-target="#sessionStartDate1" data-toggle="sessionStartDate">
                                                    <div class="input-group-text"><i class="fa fa-calendar"><!-- --></i></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <script type="text/javascript">
                                        $(function () {
                                            jQuery.datetimepicker.setLocale('en');
                                            jQuery('#sessionStartDate').datetimepicker(
                                                {
                                                    step:5,
                                                    format:'m/d/Y H:i'});
                                        });
                                    </script>


                                </div>
                            </div>
                            <div class="col">

                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="sessionSuffix">Suffix:</label>

                                    <div class="input-group col-sm-9">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="sessionSuffix3" th:text="${study.studySessionPrefix}"></span>
                                        </div>
                                        <input type="text" class="form-control" id="sessionSuffix" aria-describedby="sessionSuffix3" th:field="*{sessionSuffix}"/>
                                    </div>
                                    <div class="invalid-feedback" id="sessionSuffixError">Please provida a valid suffix use numbers and letters only</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="container">
                <fieldset class="form-group row">
                    <legend class="col-form-legend col-sm-2">Pages</legend>
                    <div class="container">
                        <fieldset class="form-group row">
                            <legend class="col-form-legend col-sm-2">Intro page</legend>
                            <div class="container" >
                                <div class="form-group row hiddable" >
                                    <label class="col-sm-3 col-form-label" for="introPageEnabled">Intro Page Enabled:</label>
                                    <div class="col-sm-9">
                                        <input class="form-check-input" th:field="*{introPageEnabled}" type="checkbox" id="introPageEnabled" data-trigger="intro" />
                                    </div>
                                </div>

                                <div class="form-group row hideable" data-hide="intro">
                                    <label class="col-sm-3 col-form-label" for="introText">Intro Text:</label>
                                    <div class="col-sm-9">
                                        <textarea class="form-control htmleditor" id="introText" th:field="*{introText}" rows="3"></textarea>
                                    </div>
                                </div>

                                <div class="form-group row hideable" data-hide="intro">
                                    <label class="col-sm-3 col-form-label" for="introTime">Intro Time:</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="number" data-number="intro" min="0" step="1" id="introTime" th:field="*{introTime}"/>
                                        <small id="introTimeHelp" class="form-text text-muted">In seconds</small>
                                        <div class="invalid-feedback">Please provide a valid time in seconds greater or equal to 5 seconds.</div>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="rosterPageEnabled">Roster Page Enabled:</label>
                                    <div class="col-sm-9">
                                        <input class="form-check-input" th:field="*{rosterPageEnabled}" data-trigger="roster"  type="checkbox" id="rosterPageEnabled" />
                                    </div>
                                </div>

                                <div class="form-group row hideable" data-hide="roster">
                                    <label class="col-sm-3 col-form-label" for="rosterTime">Roster Time:</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" data-number="roster" min="0" step="1" type="number" id="rosterTime" th:field="*{rosterTime}"/>
                                        <small id="rosterTimeHelp" class="form-text text-muted">In seconds</small>
                                        <div class="invalid-feedback">Please provide a valid time in seconds greater or equal to 5 seconds.</div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="waitingRoomTime">Waiting Room Time:</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="number"  min="0" step="1" id="waitingRoomTime" th:field="*{waitingRoomTime}"/>
                                        <small id="waitingRoomTimeHelp" class="form-text text-muted">In seconds</small>
                                        <div class="invalid-feedback">Please provide a valid time in seconds greater or equal to 5 seconds.</div>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="displayNameChangePageEnabled">Display Name Change Page Enabled:</label>
                                    <div class="col-sm-9">
                                        <input class="form-check-input" value="false" data-trigger="displayName"  th:field="*{displayNameChangePageEnabled}" type="checkbox" id="displayNameChangePageEnabled" />
                                    </div>
                                </div>

                                <div class="form-group row hideable" data-hide="displayName">
                                    <label class="col-sm-3 col-form-label" for="displayNameChangeTime">Display Name Change Time:</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="number" data-number="displayName" min="0" step="1" id="displayNameChangeTime" th:field="*{displayNameChangeTime}"/>
                                        <small id="displayNameChangeTimeHelp" class="form-text text-muted">In seconds</small>
                                        <div class="invalid-feedback">Please provide a valid time in seconds greater or equal to 5 seconds.</div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="container">
                        <fieldset class="form-group row">
                            <legend class="col-form-legend col-sm-2">Done</legend>
                            <div class="container">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="donePageEnabled">Done Page Enabled:</label>
                                    <div class="col-sm-9">
                                        <input class="form-check-input" th:field="*{donePageEnabled}" data-trigger="done"  type="checkbox" id="donePageEnabled" />
                                    </div>
                                </div>
                                <div class="form-group row hideable" data-hide="done">
                                    <label class="col-sm-3 col-form-label" for="donePageText">Done Page Text:</label>
                                    <div class="col-sm-9">
                                        <textarea class="form-control htmleditor" id="donePageText" th:field="*{donePageText}" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="form-group row hideable" data-hide="done">
                                    <label class="col-sm-3 col-form-label" for="doneRedirectUrl">Done Redirect Url:</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="text" id="doneRedirectUrl" th:field="*{doneRedirectUrl}"/>
                                        <div class="invalid-feedback">Please provide a valid URL.</div>
                                    </div>
                                </div>
                                <div class="form-group row hideable" data-hide="done">
                                    <label class="col-sm-3 col-form-label" for="donePageTime">Done Page Time:</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="number" data-number="done" min="0" step="1" id="donePageTime" th:field="*{donePageTime}"/>
                                        <small id="donePageTimeHelp" class="form-text text-muted">In seconds</small>
                                        <div class="invalid-feedback">Please provide a valid time in seconds greater or equal to 5 seconds.</div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                </fieldset>
            </div>
        </fieldset>
        <fieldset class="form-group row">
            <legend class="col-form-legend col-sm-8">Advanced - Tasks</legend>
            <div class="container">
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="taskExecutionType">Task Execution Type:</label>
                    <div class="col-sm-9">

                        <select class="custom-select" th:field="*{taskExecutionType}" id="taskExecutionType">
                            <option
                                    th:each="rg: ${taskExecutionTypes}"
                                    th:value="${rg.id}"
                                    th:text="${rg.taskExecutionType}" ></option>
                        </select>

                    </div>
                </div>
                <div class="form-group row" id="fixedInteractionTimeContainer">
                    <label class="col-sm-3 col-form-label" for="fixedInteractionTime">Fixed iteraction time:</label>
                    <div class="col-sm-9">
                        <input class="form-control" type="number" data-number="done" min="0" step="1" id="fixedInteractionTime" th:field="*{fixedInteractionTime}"/>
                        <small id="fixedInteractionTimeHelp" class="form-text text-muted">In seconds</small>
                        <div class="invalid-feedback">Please provide a valid time in seconds greater or equal to 5 seconds.</div>
                    </div>
                </div>
            </div>





        </fieldset>
        <fieldset class="form-group row">
            <legend class="col-form-legend col-sm-8">Advanced - Communication</legend>
            <div class="container">
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="chatBotName">Chat Bot Name:</label>
                    <div class="col-sm-9">
                        <input class="form-control" type="text" id="chatBotName" th:field="*{chatBotName}"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="communicationType">Communication Type:</label>
                    <div class="col-sm-9">

                        <select class="custom-select" th:field="*{communicationType}" id="communicationType">
                            <option
                                    th:each="rg: ${communicationConstraints}"
                                    th:value="${rg.id}"
                                    th:text="${rg.communicationType}" ></option>
                        </select>
                    </div>
                </div>
            </div>
        </fieldset>
        <fieldset class="form-group row">
            <legend class="col-form-legend col-sm-8">Advanced - Feedback</legend>
            <div class="container">
            <div class="form-check form-check-inline">

                        <input class="form-check-input" th:field="*{scoreboardEnabled}" type="checkbox" id="scoreboardEnabled"/>
                        <label class="col-form-label" for="scoreboardEnabled">Scoreboard Enabled</label>

            </div>
             <div class="form-check form-check-inline">

                        <label class="col-form-label" for="scoreboardDisplayType">Scoreboard Display Type:</label>
                        <select class="custom-select" th:field="*{scoreboardDisplayType}" id="scoreboardDisplayType" >
                            <option
                                    th:each="rg: ${scoreboardDisplayTypes}"
                                    th:value="${rg.id}"
                                    th:text="${rg.scoreboardDisplayType}" ></option>
                        </select>

                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" th:field="*{scoreboardUseDisplayNames}" type="checkbox"  id="scoreboardUseDisplayNames" />
                    <label class="col-form-label" for="scoreboardUseDisplayNames">Use Display Names</label>
                </div>
            </div>
        </fieldset>
        <fieldset class="form-group row">
            <legend class="col-form-legend col-sm-8">Advanced - Collaboration tools</legend>
            <div class="container">
                <div class="form-check form-check-inline">

                    <input class="form-check-input" th:field="*{collaborationTodoListEnabled}" type="checkbox" id="collaborationTodoListEnabled" />
                    <label class=" col-form-label" for="collaborationTodoListEnabled">Todo List Enabled</label>

                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" th:field="*{collaborationFeedbackWidgetEnabled}" type="checkbox" id="collaborationFeedbackWidgetEnabled" />
                    <label class=" col-form-label" for="collaborationFeedbackWidgetEnabled">Feedback Widget Enabled</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" th:field="*{collaborationVotingWidgetEnabled}" type="checkbox" id="collaborationVotingWidgetEnabled" />
                    <label class=" col-form-label" for="collaborationVotingWidgetEnabled">Voting Widget Enabled:</label>
                </div>
            </div>
        </fieldset>
        <fieldset class="form-group row">
            <legend class="col-form-legend col-sm-8">Advanced - Team composition</legend>
            <div class="container">
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="teamCreationMethod">Team Creation Method:</label>
                    <div class="col-sm-9">


                        <select class="custom-select" th:field="*{teamCreationMethod}" id="teamCreationMethod">
                            <option
                                    th:each="rg: ${teamCreationMethods}"
                                    th:value="${rg.id}"
                                    th:text="${rg.teamCreationMethod}" ></option>
                        </select>

                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="teamCreationMoment">Team Creation Moment:</label>
                    <div class="col-sm-9">
                        <select class="custom-select" th:field="*{teamCreationMoment}" id="teamCreationMoment">
                            <option
                                    th:each="rg: ${teamCreationTimes}"
                                    th:value="${rg.id}"
                                    th:text="${rg.teamCreationTime}" ></option>
                        </select>

                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="teamCreationMatrix">Team Creation Matrix:</label>
                    <div class="col-sm-9">
                        <textarea class="form-control" id="teamCreationMatrix" th:field="*{teamCreationMatrix}" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="teamMinSize">Team size:</label>
                    <div class="col-sm-9">
                        <input class="form-control" type="number" id="teamMinSize" th:field="*{teamMinSize}"/>
                        <div class="invalid-feedback">Please provide a valid team size greater or equal to 2.</div>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="couldNotAssignToTeamMessage">Could Not Assign To Team Message:</label>
                    <div class="col-sm-9">
                        <input class="form-control" type="text" id="couldNotAssignToTeamMessage" th:field="*{couldNotAssignToTeamMessage}"/>
                    </div>
                </div>


            </div>

        </fieldset>

        <!-- Begin research group field -->
        <fieldset class="form-group">
            <legend>Task groups</legend>

            <select multiple="multiple" size="10" th:field="*{sessionHasTaskGroupRelationshipBean.selectedValues}" id="taskGroups">
                <option
                        th:each="rg: ${taskGroups}"
                        th:value="${rg.id}"
                        th:text="${rg.taskGroupName}" ></option>
            </select>
        </fieldset>
        <script>
            function isValidUsernameRegex(value){
                var regexp = /^[a-zA-Z0-9]+$/;
                return (regexp.test(value));
            }
            function validateUrl(value) {
              return /^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(value);
            }
            $(function() {

                function checkboxOnClickOnLoad(){
                                    var trigg = $(this).data("trigger");
                                    if($(this).is(':checked')){
                                        console.log("trying to show stuff");
                                        $(".hideable[data-hide='"+trigg+"']").show();
                                    }else{
                                        $(".hideable[data-hide='"+trigg+"']").hide();
                                    }
                                };
                $(":checkbox").click(checkboxOnClickOnLoad);
                $(":checkbox").each(checkboxOnClickOnLoad);

                $(".htmleditor").summernote(
                    {
                    height: 200,
                    toolbar: [
                        // [groupName, [list of button]]
                        ['para', ['style','ul', 'ol', 'paragraph']],
                        ['style', ['bold', 'italic', 'underline', 'clear']],
                        ['font', ['strikethrough', 'superscript', 'subscript']],
                        ['fontsize', ['fontsize']],
                        ['color', ['color']],
                        ['insert', ['picture','link','video','table','codeview']]
                      ],
                      callbacks: {
                          onImageUpload: function(files,editorRef) {
                        console.log("Send file called success override: " + this);
                        for(let i=0; i < files.length; i++) {
                            sendFile(files[0],this);
                         }
                     }
                    }
                 });

                function sendFile(file,editor) {
                    console.log("Send file method");
                    data = new FormData();
                    data.append("file", file);
                    $.ajax({
                        data: data,
                        type: "POST",
                        url: "/images/upload?[(${_csrf.parameterName})]=[(${_csrf.token})]",
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function(url) {
                                $(editor).summernote('insertImage', url);
                        }
                    });
                }
                $('#taskGroups')
                    .bootstrapDualListbox({
                                              selectedListLabel:"Chosen groups",
                                              nonSelectedListLabel: "Available groups",
                                              moveAllLabel:"Move all",
                                              removeAllLabel: "Remove all"
                                          });
                /* hack for bootstrap 4 */
                var dualListContainer = $('#researchGroups').bootstrapDualListbox('getContainer');
                dualListContainer.find('.moveall i').removeClass().addClass('fa fa-arrow-right');
                dualListContainer.find('.removeall i').removeClass().addClass('fa fa-arrow-left');
                dualListContainer.find('.move i').removeClass().addClass('fa fa-arrow-right');
                dualListContainer.find('.remove i').removeClass().addClass('fa fa-arrow-left');
                function teamExecSetup(){
                    var ex = $("#taskExecutionType").val();
                    if(ex == "P"){
                        $("#fixedInteractionTimeContainer").show();
                    }else{
                        $("#fixedInteractionTimeContainer").hide();
                    }
                }
                function teamCreationSetup(){
                    var teamMe = $("#teamCreationMethod").val();
                    if(teamMe == "S"){
                        //hide matrix
                        //hide team size
                        $("#teamMinSize").parent().parent().hide();
                        $("#teamCreationMatrix").parent().parent().hide();
                    }
                    if(teamMe == "C"){
                        //hide matrix
                        //show team size
                        $("#teamMinSize").parent().parent().show();
                        $("#teamCreationMatrix").parent().parent().hide();
                    }
                    if(teamMe == "E"){
                        $("#teamMinSize").parent().parent().hide();
                        $("#teamCreationMatrix").parent().parent().show();
                    }


                }
                $("#taskExecutionType").change(teamExecSetup);
                $("#teamCreationMethod").change(teamCreationSetup);
                teamCreationSetup();
                teamExecSetup();
                $( "#saveSession" ).submit(function( event ) {
                    var valid = true;

                    //time checking not empty or zero
                    $(":checkbox").each(function(){

                        var trig = $(this).data("trigger");
                        if(trig){
                            if($(this).is(':checked')){

                                var numberVar = $(':input[data-number="'+trig+'"]').val();
                                if((numberVar=="" )||(parseInt(numberVar)<5)){
                                   $(':input[data-number="'+trig+'"]').addClass("is-invalid");
                                   valid = false;
                                }
                            }
                        }

                    });
                    if(!validateUrl($("#doneRedirectUrl").val())){
                        $("#doneRedirectUrl").addClass("is-invalid");
                        valid = false;
                    }

                     var teamMe = $("#teamCreationMethod").val();
                        if(teamMe == "S"){
                        }
                        if(teamMe == "C"){
                            //hide matrix
                            //show team size
                            var teamSize = $("#teamMinSize").val();
                            if(teamSize == "" || parseInt(teamSize) <= 1){
                                $("#teamMinSize").addClass("is-invalid");
                                valid = false;
                            }
                        }
                        if(teamMe == "E"){
                            var matrixvalue = $("#teamCreationMatrix").val();
                            if(matrixvalue == ""){
                                $("#teamCreationMatrix").addClass("is-invalid");
                                valid = false;
                            }
                        }
                        if(!isValidUsernameRegex($("#sessionSuffix").val())){
                            $("#sessionSuffixError").show();
                            valid = false;
                        }

                        if($("#couldNotAssignToTeamMessage").val()==""){
                            $("#couldNotAssignToTeamMessage").addClass("is-invalid");
                            valid = false;
                        }

                        var ex = $("#taskExecutionType").val();
                        if(ex == "P"){
                            var time = $("#fixedInteractionTime").val();
                            if(time == "" || parseInt(time) <5 ){
                                $("#fixedInteractionTime").addClass("is-invalid");
                                valid = false;
                            }
                        }


                    if(!valid){
                        event.preventDefault();
                        event.stopPropagation();
                      }

                });

            });
        </script>
        <!-- End research group field -->





        <!--<div class="form-group row">-->
            <!--<label class="col-sm-2 col-form-label" for="subjectCommunicationId">Subject Communication Id:</label>-->
            <!--<div class="col-sm-10">-->
                <!--<input class="form-control" type="text" id="subjectCommunicationId" th:field="*{subjectCommunicationId}"/>-->
            <!--</div>-->
        <!--</div>-->

        <a class="btn btn-danger btn-primary" th:href="${'/admin/studies/' + study.id + '/sessions/'+ sessionBean.id}">Cancel</a>

        <button th:if="${sessionBean.id == null}" type="submit" class="btn btn-primary">Create session
        </button>
        <button th:if="${sessionBean.id != null}" type="submit" class="btn btn-primary">Save session
        </button>
        <br/>
    </form>
</div>
 
</div>
</body>
</html>
